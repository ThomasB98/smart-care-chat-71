import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const openAIApiKey = Deno.env.get('OPENAI_API_KEY');

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { message, context } = await req.json();

    console.log('Received message:', message);
    console.log('Context:', context);

    const systemPrompt = `You are a professional healthcare assistant chatbot. Your role is to:

1. Provide general health information and education
2. Help users understand symptoms and when to seek medical care
3. Offer wellness tips and preventive care advice
4. Guide users through basic health assessments
5. Suggest when professional medical consultation is needed

IMPORTANT GUIDELINES:
- Always emphasize that you cannot replace professional medical diagnosis or treatment
- For serious symptoms or emergencies, always recommend seeking immediate medical attention
- Be empathetic, clear, and supportive in your responses
- Provide evidence-based information when possible
- If unsure about medical information, recommend consulting a healthcare provider
- Keep responses concise but informative
- Do not use simple, non-technical language when possible

Remember: You are providing general health information only, not medical diagnosis or treatment advice.`;

    const response = await fetch('https://api.aimlapi.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openAIApiKey}`,
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        max_tokens: 500,
        temperature: 0.7,
      }),
    });

    const data = await response.json();
    
    if (!response.ok) {
      console.error('OpenAI API error:', data);
      throw new Error(data.error?.message || 'Failed to get AI response');
    }

    const aiResponse = data.choices[0].message.content;
    
    console.log('AI Response:', aiResponse);

    return new Response(JSON.stringify({ 
      response: aiResponse,
      success: true 
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error in ai-chat function:', error);
    return new Response(JSON.stringify({ 
      error: error.message,
      success: false 
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});
